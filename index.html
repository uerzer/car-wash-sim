<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Car Wash Business Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #4A5568; /* gray-700 */
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #CBD5E0; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4299E1; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .results-card {
            background-color: #F9FAFB; /* gray-50 */
            padding: 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-top: 1rem; /* Adjusted margin */
        }
        .results-card h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1F2937; /* gray-800 */
        }
        .results-card p {
            font-size: 1rem; /* text-base */
            color: #374151; /* gray-700 */
            margin-bottom: 0.5rem;
        }
        .results-card p span {
            font-weight: 600;
            /* Default span color, overridden by specific classes below */
             color: #10B981; /* green-500 - Used for positive things like revenue */
        }
         .results-card p.cost span, .results-card p.calculated-cost span {
            color: #EF4444; /* red-500 - Used for costs */
        }
         .results-card p.calculated-cost-label {
            font-style: italic;
            color: #6B7280; /* gray-500 */
         }
        .results-card p.profit span { /* Specific profit color (blue) */
            color: #3B82F6; /* blue-500 */
        }
        .results-card p.loss span { /* Specific loss color (red) */
            color: #EF4444; /* red-500 */
        }
        .slider-container {
            margin-bottom: 1rem;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4A5568; /* gray-700 */
        }
        .section-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
            color: #374151; /* gray-700 */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #E5E7EB; /* gray-200 */
        }
         .calculated-cost-details {
            margin-top: 0.5rem;
            padding-left: 1rem;
            font-size: 0.9rem;
            color: #5A67D8; /* indigo-600 */
         }
         .calculated-cost-details p {
             margin-bottom: 0.2rem;
         }
         .calculated-cost-details span {
             font-weight: 500;
             color: #5A67D8; /* indigo-600 */
         }
        /* Remove margin-bottom for input-group inside variable cost grid */
        .variable-costs-grid .input-group {
            margin-bottom: 0;
        }
        /* Make all labels in variable cost grid the same height for alignment */
        .variable-costs-grid label {
            min-height: 2.5em;
            display: block;
        }
        /* AI Chat Widget Specific Styles */
        #aiChatWidget {
            display: none; /* Hidden by default, shown by JS */
            transition: all 0.3s ease-in-out;
            right: 1.5rem; /* Equivalent to p-4 */
            bottom: 1.5rem; /* Equivalent to p-4 */
        }
        #openChatButton {
            transition: all 0.3s ease-in-out;
            right: 1.5rem; /* Equivalent to p-4 */
            bottom: 1.5rem; /* Equivalent to p-4 */
        }
        #chatMessages {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Space between messages */
        }
        .message {
            max-width: 85%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem; /* rounded-sm on one corner */
        }
        .assistant-message {
            background-color: #E5E7EB; /* gray-200 */
            color: #1F2937; /* gray-800 */
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem; /* rounded-sm on one corner */
        }
        .loading-message,
        .error-message {
            background-color: #FEF3C7; /* yellow-100 */
            color: #92400E; /* yellow-800 */
            align-self: flex-start;
        }
        .error-message {
            background-color: #FEE2E2; /* red-100 */
            color: #991B1B; /* red-800 */
        }
        /* Responsive adjustments for AI Chat Widget */
        @media (min-width: 768px) { /* md breakpoint and up */
            #aiChatWidget {
                width: 400px; /* Wider on desktop */
                height: 500px; /* Taller on desktop */
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint and up */
            #aiChatWidget {
                width: 450px; /* Even wider on larger desktops */
                height: 550px; /* Even taller */
            }
        }
        @media (max-width: 640px) {
          .shadow-2xl { box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
          .rounded-xl { border-radius: 1rem; }
          .max-w-4xl { max-width: 99vw; }
          .p-3, .sm\:p-6 { padding: 0.75rem !important; }
          .mt-2 { margin-top: 0.5rem !important; }
          .mb-4 { margin-bottom: 0.75rem !important; }
          .w-full { width: 100% !important; }
          .input-group input, .input-group select { font-size: 1rem; }
          #authModal .max-w-sm { max-width: 98vw; }
          #authModal input { font-size: 1rem; }
          #saveScenarioBtn { width: 100%; justify-content: center; }
          #aiChatWidget { width: 99vw !important; left: 0.5vw !important; right: 0.5vw !important; min-width: unset !important; }
          #openChatButton { right: 1.5rem !important; bottom: 1.5rem !important; }
          h1 { font-size: 1.3rem !important; }
          .text-3xl { font-size: 1.5rem !important; }
          .text-2xl { font-size: 1.2rem !important; }
          .text-base { font-size: 1rem !important; }
          .text-sm { font-size: 0.95rem !important; }
          #resultsModal .max-w-lg { max-width: 100vw !important; }
          #resultsModal .bg-white {
            max-height: 100vh !important;
            height: 100vh !important;
            width: 100vw !important;
            border-radius: 0 !important;
            position: fixed !important;
            top: 0; left: 0;
            overflow-y: auto;
            z-index: 1000;
          }
          .main-calculator-container { margin-bottom: 120px !important; }
        }
        .main-calculator-container { margin-bottom: 80px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-2 sm:p-4">
    <!-- Top-right Sign In Button -->
    <button id="openAuthModal" class="fixed top-3 right-3 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg font-semibold shadow z-30 text-sm">Sign In / Create Account</button>
    <div class="bg-white p-2 sm:p-4 rounded-xl shadow-2xl w-full max-w-2xl mt-2 sm:mt-4 relative main-calculator-container flex flex-col md:flex-row gap-2 md:gap-6 items-stretch justify-between">
        <form id="simSetupForm" class="flex-1 grid grid-cols-2 gap-2 md:gap-4 items-start content-start text-sm">
            <div class="col-span-2 flex flex-col gap-1">
                <label for="operatingHours" class="font-medium text-gray-700">Operating Hours/Day</label>
                <input type="number" id="operatingHours" value="10" min="1" max="24" class="rounded border px-2 py-1">
                </div>
            <div class="col-span-2 flex flex-col gap-1">
                <label for="carsPerHour" class="font-medium text-gray-700">Avg Cars/Hour</label>
                <input type="range" id="carsPerHour" min="1" max="50" value="10" class="w-full">
                <div class="text-right text-xs text-gray-500">Value: <span id="carsPerHourValue">10</span></div>
                    </div>
            <div class="col-span-2 flex flex-col gap-1">
                <label for="avgWashPrice" class="font-medium text-gray-700">Avg Price/Wash</label>
                <select id="avgWashPrice" class="rounded border px-2 py-1">
                    <option value="7.00" data-name="Bronze Wash">Bronze Wash</option>
                    <option value="9.00" data-name="Silver Wash" selected>Silver Wash</option>
                    <option value="12.00" data-name="Gold Wash">Gold Wash</option>
                    <option value="15.00" data-name="Platinum Wash">Platinum Wash</option>
                        <option value="10.00" data-name="Custom Average">Custom Average</option>
                    </select>
                </div>
            <div class="col-span-2 flex flex-col gap-1" id="customPriceGroup" style="display:none;">
                <label for="customAvgWashPrice" class="font-medium text-gray-700">Custom Avg Price</label>
                <input type="number" id="customAvgWashPrice" value="10.00" step="0.50" min="1" class="rounded border px-2 py-1">
            </div>
            <div class="col-span-2 text-xs text-gray-400 mt-1 mb-2">Monthly Fixed Costs</div>
            <div class="flex flex-col gap-1">
                <label for="numEmployees" class="font-medium text-gray-700"># Employees</label>
                <input type="number" id="numEmployees" value="4" min="0" step="1" class="rounded border px-2 py-1">
                </div>
            <div class="flex flex-col gap-1">
                <label for="avgGrossSalary" class="font-medium text-gray-700">Avg Salary</label>
                <input type="number" id="avgGrossSalary" value="900.00" min="820.00" step="10.00" class="rounded border px-2 py-1">
                    </div>
            <div class="flex flex-col gap-1">
                <label for="monthlyRent" class="font-medium text-gray-700">Rent</label>
                <input type="number" id="monthlyRent" value="2000" min="0" step="100" class="rounded border px-2 py-1">
                    </div>
            <div class="flex flex-col gap-1">
                <label for="monthlyUtilitiesBase" class="font-medium text-gray-700">Utilities</label>
                <input type="number" id="monthlyUtilitiesBase" value="300" min="0" step="50" class="rounded border px-2 py-1">
                    </div>
            <div class="col-span-2 flex flex-col gap-1">
                <label for="monthlyInsuranceOther" class="font-medium text-gray-700">Insurance/Other</label>
                <input type="number" id="monthlyInsuranceOther" value="200" min="0" step="50" class="rounded border px-2 py-1">
                    </div>
            <div class="col-span-2 text-xs text-gray-400 mt-1 mb-2">Variable Costs Per Car</div>
            <div class="flex flex-col gap-1">
                <label for="waterCostPerCar" class="font-medium text-gray-700">Water</label>
                <input type="number" id="waterCostPerCar" value="0.30" min="0" step="0.05" class="rounded border px-2 py-1">
                    </div>
            <div class="flex flex-col gap-1">
                <label for="soapCostPerCar" class="font-medium text-gray-700">Soap/Chemicals</label>
                <input type="number" id="soapCostPerCar" value="0.50" min="0" step="0.05" class="rounded border px-2 py-1">
                </div>
            <div class="flex flex-col gap-1">
                <label for="electricityCostPerCar" class="font-medium text-gray-700">Electricity</label>
                <input type="number" id="electricityCostPerCar" value="0.40" min="0" step="0.05" class="rounded border px-2 py-1">
                    </div>
            <div class="flex flex-col gap-1">
                <label for="directLaborPerCar" class="font-medium text-gray-700">Direct Labor/Car</label>
                <input type="number" id="directLaborPerCar" value="0.00" min="0" step="0.05" class="rounded border px-2 py-1">
                    </div>
            <div class="col-span-2 mt-2">
                <button type="submit" id="calculateButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">Calculate</button>
                    </div>
        </form>
        <!-- AI Assistant placeholder will be here in next step -->
                    </div>
    <!-- Step 2: Results Modal -->
    <div id="resultsModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full relative">
            <button id="closeResultsModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700">✖</button>
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-bold">Simulation Results</h2>
                <span id="trialMeter" class="text-xs bg-gray-200 text-gray-700 rounded px-2 py-0.5 ml-2">2 free scenarios left</span>
                </div>
            <div id="resultsContent"></div>
            <div class="flex gap-2 mt-4">
                <button id="saveScenarioBtn" class="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-gray-400 font-semibold px-4 py-2 rounded-lg cursor-not-allowed relative group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0-1.104.896-2 2-2s2 .896 2 2-.896 2-2 2-2-.896-2-2zm0 0V7m0 4v4m0 0h4m-4 0H8" /></svg>
                    Save Scenario <span class="ml-1 text-xs bg-yellow-500 text-white rounded px-2 py-0.5 flex items-center"><svg xmlns='http://www.w3.org/2000/svg' class='inline h-4 w-4 mr-1' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 11c0-1.104.896-2 2-2s2 .896 2 2-.896 2-2 2-2-.896-2-2zm0 0V7m0 4v4m0 0h4m-4 0H8' /></svg>Premium</span>
                </button>
                <button id="downloadPdfBtn" class="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-gray-400 font-semibold px-4 py-2 rounded-lg cursor-not-allowed relative group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    Download PDF <span class="ml-1 text-xs bg-yellow-500 text-white rounded px-2 py-0.5 flex items-center"><svg xmlns='http://www.w3.org/2000/svg' class='inline h-4 w-4 mr-1' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 11c0-1.104.896-2 2-2s2 .896 2 2-.896 2-2 2-2-.896-2-2zm0 0V7m0 4v4m0 0h4m-4 0H8' /></svg>Premium</span>
                    </button>
                </div>
            <div class="text-xs text-gray-500 text-center mt-2">Upgrade to Premium to unlock Save and Download.</div>
        </div>
    </div>
    <!-- Paywall Modal -->
    <div id="paywallModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style="display:none;">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full relative text-center">
            <button id="closePaywallModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700">✖</button>
            <h2 class="text-xl font-bold mb-2">Upgrade to Pro</h2>
            <p class="mb-4">Unlock unlimited scenarios, save/load, PDF export, and more. Perfect for business owners and serious planners.</p>
            <div class="mb-4">
                <span class="text-2xl font-bold text-blue-600">$49/mo</span>
                <span class="text-xs text-gray-500 ml-2">Cancel anytime</span>
            </div>
            <button id="upgradeNowBtn" type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg mb-2">Upgrade Now</button>
            <div class="text-xs text-gray-400">Have a coupon or need a team plan? <a href="#" class="underline">Contact us</a></div>
                 </div>
                 </div>

    <div id="aiChatWidget" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-xl border border-gray-200 z-50 overflow-hidden w-80 h-96 flex flex-col">
        <div class="bg-blue-600 text-white p-3 font-semibold flex justify-between items-center">
            AI Assistant
            <span class="ml-2 text-xs bg-yellow-400 text-white rounded px-2 py-0.5 cursor-pointer" id="aiPremiumTeaser">More AI Chats <svg xmlns='http://www.w3.org/2000/svg' class='inline h-4 w-4 text-white' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 11c0-1.104.896-2 2-2s2 .896 2 2-.896 2-2 2-2-.896-2-2zm0 0V7m0 4v4m0 0h4m-4 0H8' /></svg></span>
            <button id="closeChat" class="text-white hover:text-gray-200 focus:outline-none">✖</button>
                </div>
        <div id="chatMessages" class="flex-1 p-3 overflow-y-auto text-sm bg-gray-50">
            <!-- Chat messages will be appended here -->
            <div class="text-center text-gray-500 py-2">Ask me anything about your car wash simulation!</div>
            </div>
        <div class="border-t border-gray-200 p-3 flex items-center">
            <input type="text" id="chatInput" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message...">
            <button id="sendMessage" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">Send</button>
        </div>
    </div>

    <button id="openChatButton" class="fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
    </button>

    <script>
        // Supabase initialization - MOVED TO TOP AND FIXED
        const supabaseUrl = 'https://iaiicqnzpupfqdqycgfr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhaWljcW56cHVwZnFkcXljZ2ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NjY2MjksImV4cCI6MjA2NDQ0MjYyOX0.-v1ERxSAysLozyylipnqjp6C14k5zg2BMqgOUISQjd4';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey); // FIX: Use window.supabase

        // Constants
        const EMPLOYER_SS_RATE = 0.2375; // ~23.75% for general regime
        const DAYS_IN_MONTH = 30;

        // DOM Elements - General Operation
        const operatingHoursEl = document.getElementById('operatingHours');
        const carsPerHourEl = document.getElementById('carsPerHour');
        const carsPerHourValueEl = document.getElementById('carsPerHourValue');
        const avgWashPriceEl = document.getElementById('avgWashPrice');
        const customAvgWashPriceEl = document.getElementById('customAvgWashPrice');
        const customPriceGroupEl = document.getElementById('customPriceGroup');

        // DOM Elements - Fixed Costs Inputs
        const numEmployeesEl = document.getElementById('numEmployees');
        const avgGrossSalaryEl = document.getElementById('avgGrossSalary');
        const monthlyRentEl = document.getElementById('monthlyRent');
        const monthlyUtilitiesBaseEl = document.getElementById('monthlyUtilitiesBase');
        const monthlyInsuranceOtherEl = document.getElementById('monthlyInsuranceOther');

        // DOM Elements - Variable Costs Inputs
        const waterCostPerCarEl = document.getElementById('waterCostPerCar');
        const soapCostPerCarEl = document.getElementById('soapCostPerCar');
        const electricityCostPerCarEl = document.getElementById('electricityCostPerCar');
        const directLaborPerCarEl = document.getElementById('directLaborPerCar');

        // Result Displays (These are now handled by generateResultsHtml, but keeping references for consistency if needed elsewhere)
        // const selectedProgramNameEl = document.getElementById('selectedProgramName');
        // const totalCarsDayEl = document.getElementById('totalCarsDay');
        // const dailyRevenueEl = document.getElementById('dailyRevenue');
        // const totalVariableCostPerCarDisplayEl = document.getElementById('totalVariableCostPerCarDisplay');
        // const dailyVariableCostsEl = document.getElementById('dailyVariableCosts');
        // const totalMonthlySalaryCostsDisplayEl = document.getElementById('totalMonthlySalaryCostsDisplay');
        // const grossMonthlySalariesDisplayEl = document.getElementById('grossMonthlySalariesDisplay');
        // const employerSSDisplayEl = document.getElementById('employerSSDisplay');
        // const totalDailyFixedCostsDisplayEl = document.getElementById('totalDailyFixedCostsDisplay');
        // const dailyProfitTextEl = document.getElementById('dailyProfitText');
        // const dailyProfitEl = document.getElementById('dailyProfit');
        // const monthlyProfitTextEl = document.getElementById('monthlyProfitText');
        // const monthlyRevenueEl = document.getElementById('monthlyRevenue');
        // const monthlyProfitEl = document.getElementById('monthlyProfit');

        const busynessIndicatorEl = document.getElementById('busynessIndicator'); // This is still in the main HTML, so keep it
        const busynessTextEl = document.getElementById('busynessText'); // This is still in the main HTML, so keep it

        // New global variable for dynamic employer SS rate
        let currentEmployerSSRate = 0; // Initialize with 0, will be set by applyCountryConfig

        // Consolidate all input elements that should trigger recalculation on 'input'
        const allRecalculatingInputEls = [
            operatingHoursEl, carsPerHourEl, customAvgWashPriceEl,
            numEmployeesEl, avgGrossSalaryEl, monthlyRentEl, monthlyUtilitiesBaseEl, monthlyInsuranceOtherEl,
            waterCostPerCarEl, soapCostPerCarEl, electricityCostPerCarEl, directLaborPerCarEl
        ];

        // Event Listeners for input changes (these will trigger calculateSimulation indirectly via generateResultsHtml)
        carsPerHourEl.addEventListener('input', () => {
            carsPerHourValueEl.textContent = carsPerHourEl.value;
            // No direct calculateSimulation call here, it's triggered by form submit
        });

        avgWashPriceEl.addEventListener('change', () => {
            const selectedOption = avgWashPriceEl.selectedOptions[0];
            const selectedName = selectedOption.dataset.name;

            if (selectedName === "Custom Average") {
                customPriceGroupEl.style.display = 'block';
            } else {
                customPriceGroupEl.style.display = 'none';
            }
            // No direct calculateSimulation call here, it's triggered by form submit
        });

         customAvgWashPriceEl.addEventListener('input', () => {
            // No direct calculateSimulation call here, it's triggered by form submit
         });

        allRecalculatingInputEls.forEach(el => {
             if (el !== carsPerHourEl && el !== customAvgWashPriceEl && el !== avgWashPriceEl) {
                // No direct calculateSimulation call here, it's triggered by form submit
             }
        });

        const countrySelectorEl = document.getElementById('countrySelector');
        let countryConfigs = {};
        let currentCountry = 'PT';
        let currentCurrency = '€';

        async function loadCountryConfigs() {
            try {
                const response = await fetch('config/countries.json');
                const data = await response.json();
                countryConfigs = {};
                data.forEach(cfg => {
                    countryConfigs[cfg.code] = cfg;
                });
            } catch (e) {
                countryConfigs = {
                    'PT': {
                        country: 'Portugal', currency: '€', minWage: 820, employerTaxRate: 0.2375, defaultRent: 2000, defaultUtilities: 300, defaultInsurance: 200,
                        defaultPerCar: { water: 0.30, soap: 0.50, electricity: 0.40, labor: 0.00 }, defaultWashPrices: [7, 9, 12, 15]
                    }
                };
            }
        }

        function updateCurrencySymbols(symbol) {
            document.querySelector('label[for="avgGrossSalary"]').innerHTML = `Avg Gross Monthly Salary per Employee (${symbol}): (Min Wage: ${symbol}${countryConfigs[currentCountry].minWage})`;
            document.querySelector('label[for="monthlyRent"]').innerHTML = `Rent (${symbol}):`;
            document.querySelector('label[for="monthlyUtilitiesBase"]').innerHTML = `Utilities (Base) (${symbol}):`;
            document.querySelector('label[for="monthlyInsuranceOther"]').innerHTML = `Insurance/Other Fixed Costs (${symbol}):`;
            document.querySelector('label[for="waterCostPerCar"]').innerHTML = `Water (${symbol}):`;
            document.querySelector('label[for="soapCostPerCar"]').innerHTML = `Soap/Chemicals (${symbol}):`;
            document.querySelector('label[for="electricityCostPerCar"]').innerHTML = `Electricity (Direct) (${symbol}):`;
            document.querySelector('label[for="directLaborPerCar"]').innerHTML = `Direct Labor (Optional, Per Car) (${symbol}):`;
            document.querySelector('label[for="customAvgWashPrice"]').innerHTML = `Enter Custom Average Price (${symbol}):`;
            document.querySelector('h3.section-title.mb-2.mt-4').innerHTML = `Monthly Fixed Costs (${symbol})`;
            document.querySelectorAll('h3.section-title.mb-2.mt-4')[1].innerHTML = `Variable Costs Per Car (${symbol})`;
        }

        function applyCountryConfig(countryCode) {
            const config = countryConfigs[countryCode];
            if (!config) return;
            currentCountry = countryCode;
            currentCurrency = config.currency;
            
            document.getElementById('avgGrossSalary').value = config.minWage;
            document.getElementById('monthlyRent').value = config.defaultRent;
            document.getElementById('monthlyUtilitiesBase').value = config.defaultUtilities;
            document.getElementById('monthlyInsuranceOther').value = config.defaultInsurance;
            document.getElementById('waterCostPerCar').value = config.defaultPerCar.water;
            document.getElementById('soapCostPerCar').value = config.defaultPerCar.soap;
            document.getElementById('electricityCostPerCar').value = config.defaultPerCar.electricity;
            document.getElementById('directLaborPerCar').value = config.defaultPerCar.labor;
            
            const avgWashPriceEl = document.getElementById('avgWashPrice');
            avgWashPriceEl.innerHTML = '';
            config.defaultWashPrices.forEach((price, idx) => {
                const name = ['Bronze', 'Silver', 'Gold', 'Platinum'][idx] || `Option ${idx+1}`;
                avgWashPriceEl.innerHTML += `<option value="${price.toFixed(2)}" data-name="${name} Wash">${name} Wash (${config.currency}${price.toFixed(2)})</option>`;
            });
            
            currentEmployerSSRate = config.employerTaxRate;

            countrySelectorEl.innerHTML = '';
            const sortedCountries = Object.values(countryConfigs).sort((a, b) => a.country.localeCompare(b.country));
            sortedCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country.country;
                countrySelectorEl.appendChild(option);
            });
            countrySelectorEl.value = currentCountry;

            updateCurrencySymbols(currentCurrency); // Update symbols after setting new currency
        }

        // Refactored calculateSimulation to return values
        function calculateSimulation(inputs) {
            const {
                operatingHours, carsPerHour, avgWashPrice, numEmployees, avgGrossSalary,
                monthlyRent, monthlyUtilitiesBase, monthlyInsuranceOther,
                waterCostPerCar, soapCostPerCar, electricityCostPerCar, directLaborPerCar
            } = inputs;

            const totalGrossMonthlySalaries = numEmployees * avgGrossSalary;
            const employerSSContribution = totalGrossMonthlySalaries * currentEmployerSSRate;
            const totalMonthlySalaryCosts = totalGrossMonthlySalaries + employerSSContribution;

            const totalMonthlyFixedCosts = totalMonthlySalaryCosts + monthlyRent + monthlyUtilitiesBase + monthlyInsuranceOther;
            const dailyFixedCosts = totalMonthlyFixedCosts / DAYS_IN_MONTH;

            const totalVariableCostPerCar = waterCostPerCar + soapCostPerCar + electricityCostPerCar + directLaborPerCar;

            const totalCarsDay = operatingHours * carsPerHour;
            const dailyRevenue = totalCarsDay * avgWashPrice;
            const dailyTotalVariableCosts = totalCarsDay * totalVariableCostPerCar;
            const dailyTotalCosts = dailyTotalVariableCosts + dailyFixedCosts;
            const dailyProfit = dailyRevenue - dailyTotalCosts;

            const monthlyRevenue = dailyRevenue * DAYS_IN_MONTH;
            const monthlyProfit = dailyProfit * DAYS_IN_MONTH;

            // Busyness Indicator - Simplified estimation
            const theoreticalCycleTimePerBayMinutes = 10;
            const theoreticalMaxCarsPerBayPerHour = 60 / theoreticalCycleTimePerBayMinutes;
            const assumedNumberOfBays = 3;
            const totalTheoreticalMaxCarsPerHour = theoreticalMaxCarsPerBayPerHour * assumedNumberOfBays;

            let busynessText = "Calculating...";
            let busynessClass = "mt-4 p-3 rounded-md text-center bg-gray-200 text-gray-600";

            if (totalCarsDay === 0 || carsPerHour === 0) {
                busynessText = "Idle";
                busynessClass = "mt-4 p-3 rounded-md text-center bg-gray-200 text-gray-600";
            } else if (carsPerHour <= totalTheoreticalMaxCarsPerHour * 0.2) {
                busynessText = "Light";
                busynessClass = "mt-4 p-3 rounded-md text-center bg-green-100 text-green-700";
            } else if (carsPerHour <= totalTheoreticalMaxCarsPerHour * 0.5) {
                 busynessText = "Moderate";
                busynessClass = "mt-4 p-3 rounded-md text-center bg-yellow-100 text-yellow-700";
            } else if (carsPerHour <= totalTheoreticalMaxCarsPerHour * 0.9) {
                 busynessText = "Busy";
                busynessClass = "mt-4 p-3 rounded-md text-center bg-orange-100 text-orange-700";
            } else {
                busynessText = `Very Busy (Potential Queues) - Est. Capacity: ${totalTheoreticalMaxCarsPerHour.toFixed(1)} cars/hr`;
                busynessClass = "mt-4 p-3 rounded-md text-center bg-red-100 text-red-700";
            }

            return {
                selectedProgramNameDisplay: inputs.selectedProgramNameDisplay, // Pass this from input gathering
                totalCarsDay, dailyRevenue, totalVariableCostPerCar, dailyTotalVariableCosts,
                totalMonthlySalaryCosts, totalGrossMonthlySalaries, employerSSContribution,
                totalDailyFixedCosts: dailyFixedCosts, dailyProfit, monthlyRevenue, monthlyProfit,
                busynessText, busynessClass
            };
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCountryConfigs();
            countrySelectorEl.value = 'US'; 
            applyCountryConfig(countrySelectorEl.value);

            carsPerHourValueEl.textContent = carsPerHourEl.value;

            const selectedOption = avgWashPriceEl.selectedOptions[0];
            if (selectedOption && selectedOption.dataset.name === "Custom Average") {
                customPriceGroupEl.style.display = 'block';
            } else {
                customPriceGroupEl.style.display = 'none';
            }
        });

        // New DOM elements for AI Chat
        const aiChatWidget = document.getElementById('aiChatWidget');
        const openChatButton = document.getElementById('openChatButton');
        const closeChatButton = document.getElementById('closeChat');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessageButton = document.getElementById('sendMessage');

        // --- AI Chat Logic ---

        openChatButton.addEventListener('click', () => {
            aiChatWidget.style.display = 'flex';
            openChatButton.style.display = 'none';
        });

        closeChatButton.addEventListener('click', () => {
            aiChatWidget.style.display = 'none';
            openChatButton.style.display = 'block';
        });

        sendMessageButton.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            chatInput.value = '';
            _appendMessageCore(message, 'user');

            chatInput.disabled = true;
            sendMessageButton.disabled = true;
            _appendMessageCore("Thinking...", 'ai-loading');

            try {
                const currentInputs = {
                    operatingHours: parseFloat(operatingHoursEl.value) || 0,
                    carsPerHour: parseFloat(carsPerHourEl.value) || 0,
                    avgWashPrice: (() => {
                        const selectedOption = avgWashPriceEl.selectedOptions[0];
                        const selectedName = selectedOption.dataset.name;
                        return selectedName === "Custom Average" ?
                               parseFloat(customAvgWashPriceEl.value) || 0 :
                               parseFloat(avgWashPriceEl.value) || 0;
                    })(),
                    numEmployees: parseFloat(numEmployeesEl.value) || 0,
                    avgGrossSalary: parseFloat(avgGrossSalaryEl.value) || 0,
                    monthlyRent: parseFloat(monthlyRentEl.value) || 0,
                    monthlyUtilitiesBase: parseFloat(monthlyUtilitiesBaseEl.value) || 0,
                    monthlyInsuranceOther: parseFloat(monthlyInsuranceOtherEl.value) || 0,
                    waterCostPerCar: parseFloat(waterCostPerCarEl.value) || 0,
                    soapCostPerCar: parseFloat(soapCostPerCarEl.value) || 0,
                    electricityCostPerCar: parseFloat(electricityCostPerCarEl.value) || 0,
                    directLaborPerCar: parseFloat(directLaborPerCarEl.value) || 0,
                    currentCountry: currentCountry,
                    currentCurrency: currentCurrency,
                    currentEmployerSSRate: currentEmployerSSRate,
                };

                const calculatedResults = calculateSimulation(currentInputs);

                const scenario = {
                    ...currentInputs,
                    ...calculatedResults
                };

                const response = await fetch('/.netlify/functions/ai-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message, scenario }),
                });

                const data = await response.json();

                if (response.ok) {
                    removeLoadingMessage();
                    const aiRaw = data.reply;
                    // Replace nerdy IDs with human-friendly labels for display
                    const aiReplyDisplay = aiRaw.replace(/`Set (\w+) to ([\d\.]+)`/g, (match, id, val) => {
                        const labels = {
                            operatingHours: "Operating Hours per Day",
                            carsPerHour: "Average Cars per Hour",
                            avgWashPrice: "Average Price per Wash",
                            numEmployees: "Number of Fixed Employees",
                            avgGrossSalary: "Avg Gross Monthly Salary per Employee",
                            monthlyRent: "Rent",
                            monthlyUtilitiesBase: "Utilities (Base)",
                            monthlyInsuranceOther: "Insurance/Other Fixed Costs",
                            waterCostPerCar: "Water Cost per Car",
                            soapCostPerCar: "Soap/Chemicals Cost per Car",
                            electricityCostPerCar: "Electricity Cost per Car",
                            directLaborPerCar: "Direct Labor Cost per Car"
                        };
                        const label = labels[id] || id;
                        return `Set **${label}** to ${val}`;
                    });
                    await typewriterReply(aiReplyDisplay);

                    const changes = parseAiSuggestions(aiRaw);
                    if (Object.keys(changes).length > 0) {
                        console.log("AI suggested changes:", changes);
                        applyAiSuggestions(changes);
                    }

                } else {
                    removeLoadingMessage();
                    appendMessage(`Error: ${data.message || 'Something went wrong.'}`, 'error');
                }

            } catch (error) {
                console.error('Frontend AI Chat Error:', error);
                removeLoadingMessage();
                appendMessage(`Network error: ${error.message}. Please try again.`, 'error');
            } finally {
                chatInput.disabled = false;
                sendMessageButton.disabled = false;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function parseAiSuggestions(text) {
            const suggestions = {};
            const regex = /Set (\w+) to (\d+\.?\d*)/g;
            let match;
            while ((match = regex.exec(text)) !== null) {
                suggestions[match[1]] = parseFloat(match[2]);
            }
            return suggestions;
        }

        function applyAiSuggestions(changes) {
            let applied = false;
            for (const key in changes) {
                const inputElement = document.getElementById(key);
                if (inputElement) {
                    const oldValue = inputElement.value;
                    inputElement.value = changes[key];
                    console.log(`Updated ${key} from ${oldValue} to ${changes[key]}`);
                    applied = true;
                    inputElement.dispatchEvent(new Event('input'));
                    if (key === 'avgWashPrice') {
                        const customOption = Array.from(avgWashPriceEl.options).find(opt => opt.dataset.name === "Custom Average");
                        if (customOption) {
                            customOption.selected = true;
                            customPriceGroupEl.style.display = 'block';
                            customAvgWashPriceEl.value = changes[key];
                            customAvgWashPriceEl.dispatchEvent(new Event('input'));
                        }
                    }
                }
            }
            if (applied) {
                // After applying suggestions, re-calculate and update results modal if open
                if (resultsModal.style.display === 'flex') {
                    showResultsModal(); // Re-render results with new values
                }
                appendMessage("Simulator inputs updated based on AI suggestions!", 'assistant');
            }
        }

        function convertMarkdownToHtml(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/^- (.*)/gm, '&bull; $1<br>');
            text = text.replace(/^\* (.*)/gm, '&bull; $1<br>');
            return text;
        }

        // Typewriter effect for AI assistant replies
        async function typewriterReply(text) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', 'p-2', 'my-1', 'rounded-lg', 'assistant-message');
            chatMessages.appendChild(msgDiv);
            let currentText = '';
            for (const char of text) {
                currentText += char;
                msgDiv.innerHTML = convertMarkdownToHtml(currentText);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                await new Promise(r => setTimeout(r, 15));
            }
        }

        function _appendMessageCore(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', 'p-2', 'my-1', 'rounded-lg');

            if (sender === 'user') {
                msgDiv.classList.add('bg-blue-500', 'text-white', 'self-end');
            } else if (sender === 'assistant') {
                msgDiv.classList.add('bg-gray-200', 'text-gray-800', 'self-start');
            } else if (sender === 'ai-loading') {
                 msgDiv.classList.add('bg-gray-100', 'text-gray-500', 'italic', 'self-start', 'loading-message');
            } else if (sender === 'error') {
                msgDiv.classList.add('bg-red-100', 'text-red-700', 'self-start', 'error-message');
            }
            msgDiv.textContent = text;
            chatMessages.appendChild(msgDiv);
        }

        const appendMessage = function(text, sender) {
            if (sender === 'assistant') {
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('message', 'p-2', 'my-1', 'rounded-lg', 'assistant-message');
                msgDiv.innerHTML = convertMarkdownToHtml(text);
                chatMessages.appendChild(msgDiv);
            } else {
                _appendMessageCore(text, sender);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        function removeLoadingMessage() {
            const loadingMessage = chatMessages.querySelector('.loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // Add modal open/close logic
        const authModal = document.getElementById('authModal');
        const openAuthModalBtn = document.getElementById('openAuthModal');
        const closeAuthModalBtn = document.getElementById('closeAuthModal');
        if (openAuthModalBtn) openAuthModalBtn.addEventListener('click', () => { authModal.style.display = 'flex'; });
        if (closeAuthModalBtn) closeAuthModalBtn.addEventListener('click', () => { authModal.style.display = 'none'; });
        window.addEventListener('click', (e) => { if (e.target === authModal) authModal.style.display = 'none'; });

        // Two-step flow logic
        let trialCount = parseInt(localStorage.getItem('trialCount') || '2', 10);
        const simSetupForm = document.getElementById('simSetupForm');
        const resultsModal = document.getElementById('resultsModal');
        const resultsContent = document.getElementById('resultsContent');
        const trialMeter = document.getElementById('trialMeter');
        const paywallModal = document.getElementById('paywallModal');
        const closeResultsModal = document.getElementById('closeResultsModal');
        const closePaywallModal = document.getElementById('closePaywallModal');

        // Prevent default form submission
        simSetupForm.addEventListener('submit', function(e) {
          e.preventDefault();

          // Allow if user has premium or free trials left
          const isPremium = localStorage.getItem('isPremium') === 'true';
          if (trialCount > 0 || isPremium) {
            showResultsModal();
            if (!isPremium) {
              trialCount--;
              localStorage.setItem('trialCount', trialCount);
              updateTrialMeter();
            }
          } else {
            showPaywallModal();
          }
        });

        function showResultsModal() {
          resultsModal.style.display = 'flex';
          // Get current input values
          const selectedOption = avgWashPriceEl.selectedOptions[0];
          const selectedName = selectedOption.dataset.name;
          const currentAvgWashPrice = selectedName === "Custom Average" ?
                               parseFloat(customAvgWashPriceEl.value) || 0 :
                               parseFloat(avgWashPriceEl.value) || 0;
          const selectedProgramNameDisplay = selectedName === "Custom Average" ? `Custom (${currentCurrency}${ (parseFloat(customAvgWashPriceEl.value) || 0).toFixed(2)})` : selectedName;

          const currentInputs = {
              operatingHours: parseFloat(operatingHoursEl.value) || 0,
              carsPerHour: parseFloat(carsPerHourEl.value) || 0,
              avgWashPrice: currentAvgWashPrice,
              numEmployees: parseFloat(numEmployeesEl.value) || 0,
              avgGrossSalary: parseFloat(avgGrossSalaryEl.value) || 0,
              monthlyRent: parseFloat(monthlyRentEl.value) || 0,
              monthlyUtilitiesBase: parseFloat(monthlyUtilitiesBaseEl.value) || 0,
              monthlyInsuranceOther: parseFloat(monthlyInsuranceOtherEl.value) || 0,
              waterCostPerCar: parseFloat(waterCostPerCarEl.value) || 0,
              soapCostPerCar: parseFloat(soapCostPerCarEl.value) || 0,
              electricityCostPerCar: parseFloat(electricityCostPerCarEl.value) || 0,
              directLaborPerCar: parseFloat(directLaborPerCarEl.value) || 0,
              selectedProgramNameDisplay: selectedProgramNameDisplay
          };

          // Calculate results
          const results = calculateSimulation(currentInputs);

          // Generate and display results HTML
          resultsContent.innerHTML = `
            <div class="space-y-2">
              <div><strong>Selected Wash Program:</strong> ${results.selectedProgramNameDisplay}</div>
              <div><strong>Total Cars per Day:</strong> ${results.totalCarsDay.toFixed(0)}</div>
              <div><strong>Estimated Daily Revenue:</strong> ${currentCurrency}${results.dailyRevenue.toFixed(2)}</div>
              <div><strong>Calculated Total Variable Cost per Car:</strong> ${currentCurrency}${results.totalVariableCostPerCar.toFixed(2)}</div>
              <div><strong>Estimated Daily Variable Costs (Total):</strong> ${currentCurrency}${results.dailyTotalVariableCosts.toFixed(2)}</div>
              <div><strong>Calculated Monthly Salary Costs (Employer):</strong> ${currentCurrency}${results.totalMonthlySalaryCosts.toFixed(2)}</div>
              <div class="pl-2 text-xs text-gray-500">Gross Salaries (Monthly): ${currentCurrency}${results.totalGrossMonthlySalaries.toFixed(2)}<br>Employer SS (Monthly, ~${(currentEmployerSSRate * 100).toFixed(2)}%): ${currentCurrency}${results.employerSSContribution.toFixed(2)}</div>
              <div><strong>Calculated Total Daily Fixed Costs:</strong> ${currentCurrency}${results.totalDailyFixedCosts.toFixed(2)}</div>
              <div class="pl-2 text-xs text-gray-500">Includes: Monthly Salary Costs, Rent, Utilities, Insurance/Other</div>
              <div><strong>Estimated Daily Profit:</strong> <span class="${results.dailyProfit < 0 ? 'text-red-500' : 'text-blue-600'}">${currentCurrency}${results.dailyProfit.toFixed(2)}</span></div>
              <div><strong>Estimated Monthly Revenue (30 days):</strong> ${currentCurrency}${results.monthlyRevenue.toFixed(2)}</div>
              <div><strong>Estimated Monthly Profit (30 days):</strong> <span class="${results.monthlyProfit < 0 ? 'text-red-500' : 'text-blue-600'}">${currentCurrency}${results.monthlyProfit.toFixed(2)}</span></div>
              <div id="busynessIndicator" class="${results.busynessClass}">
                  <p class="font-semibold">Operational Load:</p>
                  <p id="busynessText" class="text-lg font-bold">${results.busynessText}</p>
              </div>
            </div>
          `;
          // Re-attach event listeners for buttons inside the modal after content is rendered
          const saveScenarioBtn = document.getElementById('saveScenarioBtn');
          const downloadPdfBtn = document.getElementById('downloadPdfBtn');
          if (saveScenarioBtn) saveScenarioBtn.onclick = showPaywallModal;
          if (downloadPdfBtn) downloadPdfBtn.onclick = showPaywallModal;
        }

        function updateTrialMeter() {
          if (trialCount > 0) {
            trialMeter.textContent = `${trialCount} free scenario${trialCount === 1 ? '' : 's'} left`;
            trialMeter.classList.remove('bg-red-400', 'text-white');
            trialMeter.classList.add('bg-gray-200', 'text-gray-700');
          } else {
            trialMeter.textContent = 'Trial ended';
            trialMeter.classList.remove('bg-gray-200', 'text-gray-700');
            trialMeter.classList.add('bg-red-400', 'text-white');
          }
        }

        function showPaywallModal() {
          paywallModal.style.display = 'flex';
        }

        closeResultsModal.addEventListener('click', () => { resultsModal.style.display = 'none'; });
        closePaywallModal.addEventListener('click', () => { paywallModal.style.display = 'none'; });

        // Supabase Auth Functions (moved here for clarity, but initialized at top)
        async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabase.auth.signUp({ email, password });
            document.getElementById('auth-status').textContent = error ? error.message : 'Check your email for confirmation!';
            if (!error) setTimeout(() => { authModal.style.display = 'none'; }, 1200);
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            document.getElementById('auth-status').textContent = error ? error.message : 'Signed in!';
            if (!error) setTimeout(() => { authModal.style.display = 'none'; }, 800);
        }

        async function signOut() {
            await supabase.auth.signOut();
            document.getElementById('auth-status').textContent = 'Signed out!';
        }

        supabase.auth.onAuthStateChange((event, session) => {
            if (session && session.user) {
                document.getElementById('auth-status').textContent = `Logged in as ${session.user.email}`;
            } else {
                document.getElementById('auth-status').textContent = 'Not logged in';
            }
        });

        // Dummy checkout simulation for Upgrade Now button
        const upgradeBtn = document.getElementById('upgradeNowBtn');
        if (upgradeBtn) {
          upgradeBtn.addEventListener('click', () => {
            // Simulate successful purchase
            localStorage.setItem('isPremium', 'true');
            paywallModal.style.display = 'none';
            appendMessage('🎉 Thank you for upgrading to Pro! Premium features unlocked.', 'assistant');
            // Optionally update UI elements here, e.g., hide paywall triggers
          });
        }
    </script>
</body>
</html>
